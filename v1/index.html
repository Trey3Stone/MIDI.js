<html>
<body>
<h1>
	hi
</h1>
<textarea id="inputNotes">
e4,e4, ,e4, ,c4,e4, ,g4, , ,g3, , ,c4, , ,g3, , ,e3, , ,a3, ,b3, ,a#3,a3, ,g3,e4,g4,a4, ,f4,g4, ,e4, ,c4,d4,b3
</textarea>

<button id="playButton" onClick="playback()">
	Play

</button>


<script type="text/javascript">
	// DOREMI: c3,d3,e3,f3,g3,a3,b3,c4
//

	const A0_FREQ = 27.5;
	const KEYS = 8;

	const VOLUME = 0.3;

	const TEMPO = 80;
	const METER = 60 / TEMPO / 4;

	const NOTE_STEP = Math.pow(2, 1/12);

	const NOTE_TABLE = {
		'c' :  0,
		'c#':  1,
		'd' :  2,
		'd#':  3,
		'e' :  4,
		'f' :  5,
		'f#':  6,
		'g' :  7,
		'g#':  8,
		'a' :  9,
		'a#': 10,
		'b' : 11,
	}

	//noteToFreq("c#4");
/*
	let audioCon = new AudioContext();
	let oscillator = audioCon.createOscillator();

	oscillator.frequency.value = 440;
	oscillator.connect(audioCon.destination);
	oscillator.start();
	oscillator.stop(audioCon.currentTime + 3);


	inputNotes = document.getElementById("inputNotes").value;



	alert(oscillator.frequency.value);
	//alert(2);
*/

function noteToFreq(note) {
	if (note == ' ') {
		return 0;
	}

	var key = note.slice(0, -1);
	var oct = note.slice(-1);

	//document.write(note+' '+key+' '+oct+'<br>');

	// TODO: assert key and oct are valid

	var freq = A0_FREQ * Math.pow(2, parseInt(oct) + (NOTE_TABLE[key] - 9)/12);
	return freq;
}

function compile() {
	var inputNotes = document.getElementById("inputNotes").value.trim().toLowerCase().split(",");

	var notes = inputNotes.map(function(value) {return noteToFreq(value);});

	return notes;
/*
	for (var note in inputNotes) {
		var freq2 = 

		notes.push(freq2);
		

	}
*/
	

}


function playback() {
	var notes = compile()


	var audioCtx = new (window.AudioContext || window.webkitAudioContext)
	// we create the gain module, named as volume, and connect it to our
	var volume = audioCtx.createGain();
	volume.connect(audioCtx.destination);
	//these sines are the same, exept for the last connect statement.
	//Now they are connected to the volume gain module and not to the au
	var wave = audioCtx.createOscillator();
	wave.frequency.value = 440;
	//wave.detune.value = -100;
	//sinea.type = "sine";
	volume.gain.value = 0;
	wave.start();
	//wave.stop(audioCtx.currentTime + 3);
	wave.connect(volume);

	playRecursive(audioCtx, wave, volume, notes, 0);

}

function playRecursive(context, wave, volume, notes, i) {
	if (i >= notes.length) {
		wave.stop(context.currentTime + 0.1);
		return;
	}

	document.write(notes[i]+'\n');

	if (notes[i] != ' ') {
		

		wave.frequency.value = notes[i];
		//volume.gain.value = 0.2;
		volume.gain.setTargetAtTime(VOLUME, context.currentTime, 0.01);

		volume.gain.setTargetAtTime(0, context.currentTime + 0.95*METER, 0.01);
	}

	setTimeout(playRecursive, 1000*METER, context, wave, volume, notes, i+1);
}



</script>

</body>
</html>